# GNX Stage Profiling 数据分析报告

## 1. 数据概览

- **数据来源**: `lookup_table.json`
- **总条目数**: 285
- **设备**: CPU, GPU, NPU
- **Stages**: [1, 2, 3, 4, 5, 6, 7]
- **Node 规模**: ['1k', '2k', '3k', '5k', '10k']
- **Edge 规模**: ['1k', '2k', '3k', '5k', '10k']

### Stage 定义

| Stage | 名称 | 操作 | 依赖 |
|-------|------|------|------|
| 1 | GATHER | 收集邻居特征 | nodes, edges |
| 2 | MESSAGE | 消息函数 (identity) | edges |
| 3 | REDUCE_SUM | 聚合求和 | nodes, edges |
| 4 | REDUCE_COUNT | 计算邻居数 | nodes, edges |
| 5 | NORMALIZE | 计算均值 | nodes |
| 6 | TRANSFORM | 线性变换 | nodes |
| 7 | ACTIVATE | ReLU 激活 | nodes |

## 2. Stage 延迟分析

### 平均延迟 (ms)

| Stage | CPU | GPU | NPU | GPU vs CPU | NPU vs CPU |
|-------|-----|-----|-----|------------|------------|
| 1 | 10.58 | 7.95 | 17.85 | 1.33x | 0.59x |
| 2 | 3.61 | 5.46 | 9.53 | 0.66x | 0.38x |
| 3 | 19.22 | 5.69 | (跳过) | 3.38x | - |
| 4 | 0.27 | 0.76 | (跳过) | 0.36x | - |
| 5 | 1.61 | 3.66 | 10.67 | 0.44x | 0.15x |
| 6 | 9.46 | 4.72 | 11.41 | 2.00x | 0.83x |
| 7 | 1.99 | 3.01 | 7.66 | 0.66x | 0.26x |

> **注**: GPU vs CPU > 1 表示 GPU 更快；NPU Stage 3/4 被跳过（不支持 scatter_add）

## 3. 设备性能分析

### CPU

| Stage | Avg (ms) | Min (ms) | Max (ms) | Std (ms) |
|-------|----------|----------|----------|----------|
| 1 | 10.58 | 2.72 | 28.14 | 5.96 |
| 2 | 3.61 | 0.53 | 6.96 | 2.39 |
| 3 | 19.22 | 2.76 | 46.38 | 14.01 |
| 4 | 0.27 | 0.16 | 0.51 | 0.10 |
| 5 | 1.61 | 0.57 | 5.60 | 1.25 |
| 6 | 9.46 | 3.21 | 32.05 | 7.88 |
| 7 | 1.99 | 0.57 | 6.99 | 1.61 |

### GPU

| Stage | Avg (ms) | Min (ms) | Max (ms) | Std (ms) |
|-------|----------|----------|----------|----------|
| 1 | 7.95 | 3.26 | 14.04 | 3.20 |
| 2 | 5.46 | 1.25 | 9.88 | 2.98 |
| 3 | 5.69 | 1.91 | 14.39 | 3.13 |
| 4 | 0.76 | 0.59 | 1.17 | 0.15 |
| 5 | 3.66 | 1.46 | 11.66 | 2.57 |
| 6 | 4.72 | 1.74 | 13.90 | 3.23 |
| 7 | 3.01 | 1.17 | 9.49 | 2.13 |

### NPU

| Stage | Avg (ms) | Min (ms) | Max (ms) | Std (ms) |
|-------|----------|----------|----------|----------|
| 1 | 17.85 | 3.56 | 37.76 | 10.25 |
| 2 | 9.53 | 2.25 | 18.25 | 4.78 |
| 3 | - | - | - | - |
| 4 | - | - | - | - |
| 5 | 10.67 | 4.02 | 32.99 | 7.29 |
| 6 | 11.41 | 4.06 | 37.67 | 8.17 |
| 7 | 7.66 | 2.43 | 18.25 | 4.16 |

## 4. 规模影响分析

### 10k Nodes 基准测试

| Stage | CPU (ms) | GPU (ms) | NPU (ms) |
|-------|----------|----------|----------|
| 1 | 10.29 | 10.92 | 37.76 |
| 2 | 6.80 | 9.37 | 14.12 |
| 3 | 28.49 | 14.39 | - |
| 4 | 0.39 | 0.59 | - |
| 5 | 5.60 | 11.66 | 32.99 |
| 6 | 32.05 | 13.90 | 37.67 |
| 7 | 6.99 | 9.49 | 18.25 |

## 5. 关键发现

### GPU 优势 Stage

1. **Stage 3 (REDUCE_SUM)**: GPU 加速 ~3.4x
   - scatter_add 操作在 GPU 上高效并行
   - NPU 不支持此操作

2. **Stage 6 (TRANSFORM)**: GPU 加速 ~2.0x
   - 矩阵乘法密集计算
   - GPU 的 CUDA cores 优势明显

### NPU 限制

1. **Stage 3/4 不可用**: NPU 不支持 scatter_add 操作
2. **小规模数据效率低**: 启动开销 > 计算时间
3. **Stage 5-7 适合 NPU**: 密集向量/矩阵操作

### Stage 2 特殊性

- **Identity 函数**: 实际计算量为 0
- **单独 profiling 有误导**: 测量的是数据传输开销
- **融合执行时可忽略**: 与相邻 Stage 合并时成本为 0

## 6. 调度建议

### 推荐 PEP 配置

```
Block 0: [CPU] Stage 1-4   # scatter 操作，NPU 不支持
Block 1: [GPU] Stage 5-7   # 密集计算，GPU 加速明显
```

或者：

```
Block 0: [CPU] Stage 1-4
Block 1: [GPU+NPU] Stage 5-7  # GPU/NPU 并行分担负载
```

## 7. 待更新

- [ ] 运行 1k-100k 规模的新 profiling
- [ ] 验证大规模数据下的设备性能差异
- [ ] 更新 cost model 参数

---

*生成时间: 基于 1k-10k nodes 的 profiling 数据*