# GPU Fused Block0 vs Separate Stages 分析报告

## 概述

本报告对比了 GPU 上 Fused Block0 (Stages 1-4 融合) 与分开执行 Stages 1-4 的性能差异。

- **Fused Block0**: 将 GATHER, MESSAGE, REDUCE_SUM, REDUCE_COUNT 四个操作融合为一个 OpenVINO 模型
- **Separate Stages**: 每个 Stage 单独编译和执行

## 测试环境

- CPU: Intel Core Ultra 9 185H
- GPU: Intel Arc Graphics (集成)
- 数据来源:
  - Fused: `profiling_fused/results/186H/Test2/block0_gpu.json`
  - Separate: `profiling/results/185H/checkpoint_cpugpu.json`

## 详细对比

### 完整对比表 (包含所有 4 个 Stage)

| Nodes | Edges | S1 (ms) | S2 (ms) | S3 (ms) | S4 (ms) | Sum (ms) | Fused (ms) | Speedup |
|-------|-------|---------|---------|---------|---------|----------|------------|---------|
| 5000 | 50000 | 40.32 | 47.91 | 28.58 | 0.75 | 117.55 | 13.88 | **8.47x** |
| 10000 | 100000 | 82.79 | 101.38 | 53.78 | 0.87 | 238.82 | 28.40 | **8.41x** |
| 20000 | 200000 | 154.40 | 193.22 | 110.24 | 1.00 | 458.85 | 57.17 | **8.03x** |
| 50000 | 500000 | 413.09 | 470.21 | 273.53 | 1.94 | 1158.77 | 138.37 | **8.37x** |
| 80000 | 800000 | 628.57 | 733.71 | 434.87 | 2.81 | 1799.96 | 215.74 | **8.34x** |
| 100000 | 1000000 | 786.81 | 908.92 | 539.12 | 3.28 | 2238.13 | 272.23 | **8.22x** |

### 统计摘要

| 指标 | 值 |
|------|-----|
| 平均 Speedup | **8.31x** ± 0.15 |
| 中位数 Speedup | **8.36x** |
| 最小 Speedup | 8.03x |
| 最大 Speedup | 8.47x |

## 不含 Stage 2 (MESSAGE) 的对比

Stage 2 (MESSAGE) 是简单的元素级乘法操作，在某些场景下可能不需要。以下是排除 S2 后的对比：

| Nodes | Edges | S1+S3+S4 (ms) | Fused (ms) | Speedup (无S2) |
|-------|-------|---------------|------------|----------------|
| 5000 | 50000 | 69.64 | 13.88 | **5.02x** |
| 10000 | 100000 | 137.44 | 28.40 | **4.84x** |
| 20000 | 200000 | 265.63 | 57.17 | **4.65x** |
| 50000 | 500000 | 688.56 | 138.37 | **4.98x** |
| 80000 | 800000 | 1066.25 | 215.74 | **4.94x** |
| 100000 | 1000000 | 1329.21 | 272.23 | **4.88x** |

### 统计摘要 (不含 S2)

| 指标 | S1+S2+S3+S4 | S1+S3+S4 (无S2) |
|------|-------------|-----------------|
| 平均 Speedup | 8.31x | **4.88x** |
| 中位数 Speedup | 8.36x | **4.91x** |

## 各 Stage 时间占比分析

| Nodes | Edges | S1 占比 | S2 占比 | S3 占比 | S4 占比 |
|-------|-------|---------|---------|---------|---------|
| 5000 | 50000 | 34.3% | 40.8% | 24.3% | 0.6% |
| 10000 | 100000 | 34.7% | 42.4% | 22.5% | 0.4% |
| 20000 | 200000 | 33.6% | 42.1% | 24.0% | 0.2% |
| 50000 | 500000 | 35.6% | 40.6% | 23.6% | 0.2% |
| 80000 | 800000 | 34.9% | 40.8% | 24.2% | 0.2% |
| 100000 | 1000000 | 35.2% | 40.6% | 24.1% | 0.1% |
| **平均** | - | **34.7%** | **41.2%** | **23.8%** | **0.3%** |

## 关键发现

1. **Fused Block0 显著更快**: 融合后平均加速 **8.31x**

2. **Stage 2 (MESSAGE) 占比最大**: 
   - 平均占分开执行时间的 **41.2%**
   - 这是一个简单的元素级乘法，但单独执行开销很大

3. **融合收益来源**:
   - 减少 CPU↔GPU 数据传输 (4 次 → 1 次)
   - 减少 kernel launch 开销
   - 提高内存局部性，中间结果留在 GPU 缓存
   - OpenVINO 编译器优化融合图

4. **即使不含 S2，融合仍快 4.88x**:
   - 说明融合带来的加速不仅仅是省掉了 S2 的开销
   - 数据传输和 kernel launch 开销是主要瓶颈

## 建议

1. **调度策略**: 在 GPU 上应尽量使用 Fused Block 而不是单独的 Stage
2. **内存限制**: 大规模数据 (edges > 2M) 会触发 GPU OOM，需要回退到 CPU 或分块处理
3. **混合执行**: 考虑将 Fused Block0 放在 GPU，Block1 (Stages 5-7) 根据数据规模选择设备

## 附录: Fused-Only 测试用例

以下测试用例仅有 Fused 数据，没有对应的 Separate Stages 数据：

| Nodes | Edges | Fused (ms) |
|-------|-------|------------|
| 5000 | 125000 | 29.19 |
| 5000 | 200000 | 39.49 |
| 5000 | 250000 | 48.26 |
| 5000 | 300000 | 62.00 |
| 5000 | 375000 | 78.56 |
| 5000 | 500000 | 103.21 |
| 10000 | 250000 | 55.95 |
| 10000 | 400000 | 105.02 |
| 10000 | 500000 | 108.96 |
| 10000 | 600000 | 127.02 |
| 10000 | 750000 | 154.24 |
| 10000 | 1000000 | 208.95 |
| 20000 | 500000 | 112.76 |
| 20000 | 800000 | 173.80 |
| 20000 | 1000000 | 215.15 |
| 20000 | 1200000 | 249.92 |
| 20000 | 1500000 | 311.42 |
| 20000 | 2000000 | 415.97 |
| 50000 | 1250000 | 294.03 |
| 50000 | 2000000 | 436.30 |
| 80000 | 2000000 | 457.83 |

---
*报告生成时间: 2025-01*
